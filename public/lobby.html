<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼è›‹æ¸¸æˆå¤§å…</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .room-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
        }
        .room-item {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-list {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸƒ æ¼è›‹æ¸¸æˆå¤§å…</h1>
    
    <div class="container">
        <div class="section">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus" class="status disconnected">æ­£åœ¨è¿æ¥...</div>
            <div id="userInfo" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px;"></div>
            <div style="margin-top: 10px;">
                <button id="disconnectBtn" onclick="logout()" disabled>é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ¿é—´æ“ä½œ</h3>
            <div>
                <input type="text" id="roomName" placeholder="æˆ¿é—´åç§°" value="æµ‹è¯•æˆ¿é—´">
                <button id="createRoomBtn" onclick="createRoom()" disabled>åˆ›å»ºæˆ¿é—´</button>
            </div>
            <div>
                <input type="text" id="joinRoomId" placeholder="æˆ¿é—´ID">
                <button id="joinRoomBtn" onclick="joinRoom()" disabled>åŠ å…¥æˆ¿é—´</button>
                <button id="refreshRoomsBtn" onclick="getRooms()" disabled>åˆ·æ–°æˆ¿é—´åˆ—è¡¨</button>
            </div>
            <div>
                <button id="startGameBtn" onclick="startGame()" disabled>å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ¿é—´åˆ—è¡¨</h3>
            <div id="roomList" class="room-list">
                <p>è¯·å…ˆè¿æ¥WebSocket...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>å½“å‰æˆ¿é—´ä¿¡æ¯</h3>
            <div id="currentRoom">
                <p>æœªåŠ å…¥ä»»ä½•æˆ¿é—´</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æ¸¸æˆçŠ¶æ€</h3>
            <div id="gameState">
                <p>æœªå¼€å§‹æ¸¸æˆ</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ‘çš„æ‰‹ç‰Œ</h3>
            <div id="playerHand">
                <p>æœªå‘ç‰Œ</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>å‡ºç‰Œæ“ä½œ</h3>
            <div id="selectedCards" style="min-height: 60px; background: #f8f9fa; border: 2px dashed #ccc; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                <p style="color: #666; margin: 0;">è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œï¼ˆç‚¹å‡»æ‰‹ç‰Œé€‰æ‹©ï¼‰</p>
            </div>
            <div style="margin-bottom: 10px;">
                <span id="cardTypeDisplay" style="font-weight: bold; color: #007bff;">ç‰Œå‹: æœªé€‰æ‹©</span>
            </div>
            <div>
                <button id="confirmPlayBtn" onclick="confirmPlay()" disabled style="background: #28a745; margin-right: 10px;">ç¡®è®¤å‡ºç‰Œ</button>
                <button id="clearSelectionBtn" onclick="clearSelection()" disabled>æ¸…ç©ºé€‰æ‹©</button>
                <button id="passTurnBtn" onclick="passTurn()" style="display: none; margin-left: 10px;" disabled>è¿‡ç‰Œ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æ¶ˆæ¯æ—¥å¿—</h3>
            <div id="messageLog" class="log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        let socket = null;
        let currentToken = null;
        let currentRoom = null;

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('messageLog');
            logDiv.innerHTML += `<div>[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.textContent = 'ğŸŸ¢ å·²è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'ğŸ”´ æœªè¿æ¥';
                statusDiv.className = 'status disconnected';
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('createRoomBtn').disabled = !connected;
            document.getElementById('joinRoomBtn').disabled = !connected;
            document.getElementById('refreshRoomsBtn').disabled = !connected;
            
            // æ ¹æ®æˆ¿é—´çŠ¶æ€å’Œäººæ•°åŠ¨æ€æ§åˆ¶å¼€å§‹æ¸¸æˆæŒ‰é’®
            updateStartGameButton();
            // å‡ºç‰ŒæŒ‰é’®çŠ¶æ€ç”± updateTurnBasedButtons() ç®¡ç†
        }
        
        // æ›´æ–°å›åˆåˆ¶æŒ‰é’®çŠ¶æ€
        function updateTurnBasedButtons() {
            const startGameBtn = document.getElementById('startGameBtn');
            const passTurnBtn = document.getElementById('passTurnBtn');
            const currentUserInfo = getCurrentUserInfo();
            
            if (!currentUserInfo || !gameState) {
                passTurnBtn.style.display = 'none';
                return;
            }

            const isMyTurn = currentPlayerId && currentPlayerId == currentUserInfo.id;
            const isGamePlaying = gameState && gameState.gamePhase === 'playing';

            if (isGamePlaying) {
                // æ¸¸æˆè¿›è¡Œä¸­ï¼Œæ˜¾ç¤ºè¿‡ç‰ŒæŒ‰é’®
                passTurnBtn.style.display = 'inline-block';
                passTurnBtn.disabled = !isMyTurn;
                passTurnBtn.textContent = isMyTurn ? 'è¿‡ç‰Œ' : 'ç­‰å¾…ä¸­...';
                
                // éšè—å¼€å§‹æ¸¸æˆæŒ‰é’®
                startGameBtn.style.display = 'none';
                
                // æ›´æ–°å‡ºç‰ŒæŒ‰é’®çŠ¶æ€
                updatePlayButtons();
                
                log(`ğŸ¯ å›åˆçŠ¶æ€æ›´æ–°: isMyTurn=${isMyTurn}, currentPlayerId=${currentPlayerId}, myId=${currentUserInfo.id}`);
            } else {
                // æ¸¸æˆæœªå¼€å§‹ï¼Œéšè—è¿‡ç‰ŒæŒ‰é’®
                passTurnBtn.style.display = 'none';
                startGameBtn.style.display = 'inline-block';
                
                // é‡ç½®é€‰æ‹©å’ŒæŒ‰é’®çŠ¶æ€
                clearSelection();
            }
        }

        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        function getCurrentUserInfo() {
            const userInfoStr = localStorage.getItem('user_info');
            return userInfoStr ? JSON.parse(userInfoStr) : null;
        }

        // åŠ¨æ€æ›´æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€
        function updateStartGameButton() {
            const startGameBtn = document.getElementById('startGameBtn');
            const connected = socket && socket.connected;
            
            if (!connected || !currentRoom) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
                return;
            }
            
            const playerCount = currentRoom.players ? currentRoom.players.length : 0;
            const isPlaying = currentRoom.status === 'playing';
            
            if (isPlaying) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = 'æ¸¸æˆè¿›è¡Œä¸­...';
                startGameBtn.style.display = 'none'; // éšè—æŒ‰é’®
            } else if (playerCount >= 4) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `æ»¡å‘˜è‡ªåŠ¨å¼€å§‹ (${playerCount}/4äºº)`;
                startGameBtn.style.backgroundColor = '#28a745'; // ç»¿è‰²è¡¨ç¤ºæ»¡å‘˜
            } else {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `ç­‰å¾…ç©å®¶ (${playerCount}/4äºº)`;
                startGameBtn.style.backgroundColor = '#ccc'; // ç°è‰²è¡¨ç¤ºç­‰å¾…
                startGameBtn.style.display = 'block'; // æ˜¾ç¤ºæŒ‰é’®
            }
        }


        function connect() {
            if (!currentToken) {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°ç™»å½•Tokenï¼Œæ­£åœ¨é‡å®šå‘åˆ°ç™»å½•é¡µ...');
                window.location.href = '/login.html';
                return;
            }

            log(`ğŸ”— å°è¯•è¿æ¥Socket.IO WebSocketæœåŠ¡å™¨...`);
            log(`ğŸ”‘ ä½¿ç”¨Token: ${currentToken.substring(0, 20)}...`);
            
            // Socket.IO è¿æ¥ - æ­£ç¡®é…ç½®è·¯å¾„
            const ioSocket = io({
                path: '/ws/socket.io/',  // æ­£ç¡®çš„Socket.IOè·¯å¾„
                auth: {
                    token: currentToken
                },
                transports: ['websocket', 'polling'], // å…è®¸é™çº§åˆ°polling
                timeout: 10000, // 10ç§’è¿æ¥è¶…æ—¶
                forceNew: true  // å¼ºåˆ¶åˆ›å»ºæ–°è¿æ¥
            });

            socket = ioSocket;

            ioSocket.on('connect', function() {
                log('âœ… Socket.IOè¿æ¥æˆåŠŸ');
                updateStatus(true);
            });

            ioSocket.on('disconnect', function() {
                log('âŒ Socket.IOè¿æ¥æ–­å¼€');
                updateStatus(false);
            });

            ioSocket.on('rooms_list', function(data) {
                log(`ğŸ“‹ æ”¶åˆ°æˆ¿é—´åˆ—è¡¨: ${JSON.stringify(data)}`);
                displayRooms(data.rooms || []);
            });

            ioSocket.on('room_created', function(data) {
                log(`ğŸ  æˆ¿é—´åˆ›å»ºå“åº”: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_joined', function(data) {
                log(`ğŸšª åŠ å…¥æˆ¿é—´å“åº”: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_update', function(data) {
                log(`ğŸ”„ æˆ¿é—´æ›´æ–°: ${JSON.stringify(data)}`);
                if (data.room) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                    // åŠ¨æ€æ›´æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€
                    updateStartGameButton();
                    // æ›´æ–°å›åˆåˆ¶æŒ‰é’®çŠ¶æ€
                    updateTurnBasedButtons();
                    // åˆ·æ–°æˆ¿é—´åˆ—è¡¨
                    getRooms();
                }
                
                // å¤„ç†è‡ªåŠ¨å¼€å§‹æ¸¸æˆçš„ç‰¹æ®Šæ¶ˆæ¯
                if (data.type === 'auto_game_started') {
                    log(`ğŸ® ${data.message}`);
                    // æ˜¾ç¤ºè‡ªåŠ¨å¼€å§‹çš„é€šçŸ¥
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed; top: 20px; right: 20px;
                        background: #28a745; color: white;
                        padding: 15px 20px; border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000; font-weight: bold;
                    `;
                    notification.textContent = 'ğŸ® ' + data.message;
                    document.body.appendChild(notification);
                    
                    // 3ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 3000);
                }
            });

            ioSocket.on('connect_error', function(error) {
                log(`âŒ Socket.IOè¿æ¥é”™è¯¯: ${error.message}`);
                log(`âŒ é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`);
                updateStatus(false);
            });

            ioSocket.on('disconnect', function(reason) {
                log(`ğŸ”Œ Socket.IOæ–­å¼€è¿æ¥ï¼ŒåŸå› : ${reason}`);
                updateStatus(false);
            });

            // æ·»åŠ æ›´å¤šè°ƒè¯•äº‹ä»¶
            ioSocket.on('connecting', function() {
                log(`ğŸ”„ Socket.IOæ­£åœ¨è¿æ¥...`);
            });

            ioSocket.on('reconnect', function() {
                log(`ğŸ”„ Socket.IOå·²é‡è¿`);
                updateStatus(true);
            });

            ioSocket.on('reconnect_error', function(error) {
                log(`âŒ Socket.IOé‡è¿å¤±è´¥: ${error.message}`);
            });

            // æ¸¸æˆç›¸å…³äº‹ä»¶
            ioSocket.on('game_started', function(data) {
                log(`ğŸ® æ¸¸æˆå¼€å§‹: ${JSON.stringify(data)}`);
                
                if (data.gameState) {
                    gameState = data.gameState;
                    currentPlayerId = data.gameState.currentPlayerId || data.gameState.playOrder[0];
                    updateGameState(data);
                    updateTurnBasedButtons(); // æ›´æ–°å›åˆåˆ¶æŒ‰é’®çŠ¶æ€
                    
                    log(`ğŸ¯ æ¸¸æˆç©å®¶é¡ºåº: [${data.gameState.playOrder.join(', ')}]`);
                    log(`ğŸ¯ å½“å‰è½®åˆ°ç©å®¶: ${currentPlayerId}`);
                }
            });

            // ç›‘å¬å›åˆæ›´æ–°äº‹ä»¶
            ioSocket.on('turn_update', function(data) {
                log(`ğŸ”„ å›åˆæ›´æ–°: ${JSON.stringify(data)}`);
                currentPlayerId = data.currentPlayerId;
                updateTurnBasedButtons(); // æ›´æ–°å›åˆåˆ¶æŒ‰é’®çŠ¶æ€
                
                if (data.message) {
                    log(`ğŸ“¢ ${data.message}`);
                }
            });

            // ç›‘å¬è¿‡ç‰Œç»“æœ
            ioSocket.on('pass_turn_result', function(data) {
                if (data.success) {
                    log(`âœ… ${data.message}`);
                } else {
                    log(`âŒ è¿‡ç‰Œå¤±è´¥: ${data.message}`);
                    alert(data.message);
                }
            });

            // ç›‘å¬å‡ºç‰Œäº‹ä»¶
            ioSocket.on('cards_played', function(data) {
                log(`ğŸƒ ${data.message || data.playerName + ' å‡ºç‰Œ: ' + data.cards.length + 'å¼ ï¼Œå‰©ä½™' + data.remainingCards + 'å¼ '}`);
                
                // å¦‚æœæ˜¯å½“å‰ç©å®¶å‡ºç‰ŒæˆåŠŸï¼Œæ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º
                const currentUserInfo = getCurrentUserInfo();
                if (currentUserInfo && data.playerId === currentUserInfo.id) {
                    // ä»æ‰‹ç‰Œä¸­ç§»é™¤å·²å‡ºçš„ç‰Œ
                    const playedCards = data.cards;
                    playedCards.forEach(playedCard => {
                        const cardIndex = playerHand.findIndex(handCard => 
                            handCard.suit === playedCard.suit && handCard.rank === playedCard.rank
                        );
                        if (cardIndex >= 0) {
                            playerHand.splice(cardIndex, 1);
                        }
                    });
                    displayPlayerHand(playerHand);
                    clearSelection();
                }
            });

            // ç›‘å¬å›åˆå˜æ›´äº‹ä»¶
            ioSocket.on('turn_update', function(data) {
                if (data.currentPlayerId) {
                    currentPlayerId = data.currentPlayerId;
                    log(`ğŸ¯ ${data.message || 'è½®åˆ°ä¸‹ä¸€ä½ç©å®¶'}`);
                    
                    // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤ºå’ŒæŒ‰é’®çŠ¶æ€
                    if (gameState) {
                        gameState.currentPlayer = data.currentPlayerId;
                        updateGameState(gameState);
                    }
                    updateTurnBasedButtons();
                }
            });

            // ç›‘å¬å‡ºç‰Œç»“æœ
            ioSocket.on('play_cards_result', function(data) {
                if (data.success) {
                    log(`âœ… ${data.message}`);
                    // å‡ºç‰ŒæˆåŠŸåæ¸…ç©ºé€‰æ‹©
                    clearSelection();
                } else {
                    log(`âŒ å‡ºç‰Œå¤±è´¥: ${data.message}`);
                    alert(data.message);
                }
            });

            // ç›‘å¬è¿‡ç‰Œç»“æœ
            ioSocket.on('pass_turn_result', function(data) {
                if (data.success) {
                    log(`âœ… è¿‡ç‰ŒæˆåŠŸ`);
                } else {
                    log(`âŒ è¿‡ç‰Œå¤±è´¥: ${data.message}`);
                    alert(data.message);
                }
            });

            ioSocket.on('your_hand', function(data) {
                log(`ğŸƒ æ”¶åˆ°æ‰‹ç‰Œ: ${data.playerCount}å¼ ç‰Œ`);
                displayPlayerHand(data.cards);
            });

            ioSocket.on('card_played', function(data) {
                log(`ğŸ¯ ç©å®¶å‡ºç‰Œ: ${data.username} å‡ºäº† ${data.cards.length}å¼ ${data.playType}ï¼Œå‰©ä½™${data.remainingCards}å¼ `);
                updateGameState({ currentPlayer: data.nextPlayer });
            });

            ioSocket.on('game_finished', function(data) {
                log(`ğŸ† æ¸¸æˆç»“æŸ: ${data.message}`);
                updateGameState({ gamePhase: 'finished', winner: data.winner });
            });

            // ç›‘å¬æ–­çº¿é‡è¿æˆåŠŸäº‹ä»¶
            ioSocket.on('reconnect_success', function(data) {
                log(`ğŸ”„ é‡è¿æˆåŠŸ: ${data.message}`);
                
                // æ¢å¤æˆ¿é—´çŠ¶æ€
                if (data.room) {
                    currentRoom = data.room;
                    log(`ğŸ  å·²æ¢å¤æˆ¿é—´çŠ¶æ€: ${data.room.id}`);
                    updateStartGameButton();
                }
                
                // æ¢å¤æ¸¸æˆçŠ¶æ€
                if (data.gameState) {
                    log(`ğŸ® å·²æ¢å¤æ¸¸æˆçŠ¶æ€ï¼Œå½“å‰è½®åˆ°: ç©å®¶${data.gameState.currentPlayer}`);
                    currentPlayerId = data.gameState.currentPlayer;
                    gameState = data.gameState;
                    updateTurnBasedButtons();
                    updateGameState(data.gameState);
                }
                
                // æ¢å¤æ‰‹ç‰Œ
                if (data.yourCards && data.yourCards.length > 0) {
                    log(`ğŸƒ å·²æ¢å¤æ‰‹ç‰Œ: ${data.yourCards.length}å¼ `);
                    displayPlayerHand(data.yourCards);
                }
                
                // è¯·æ±‚å®Œæ•´çš„æ¸¸æˆæ—¥å¿—
                if (data.room) {
                    socket.emit('request_game_logs', { roomId: data.room.id });
                }
                
                alert('é‡è¿æˆåŠŸï¼å·²æ¢å¤åˆ°æ–­çº¿å‰çš„æ¸¸æˆçŠ¶æ€ã€‚');
            });

            // ç›‘å¬ç©å®¶æ–­çº¿äº‹ä»¶
            ioSocket.on('player_disconnected', function(data) {
                log(`ğŸ”Œ ${data.playerName} æ–­çº¿äº†ï¼Œç­‰å¾…é‡è¿...`);
            });

            // ç›‘å¬ç©å®¶é‡è¿äº‹ä»¶
            ioSocket.on('player_reconnected', function(data) {
                log(`ğŸ”— ${data.playerName} é‡æ–°è¿æ¥äº†`);
            });

            // ç›‘å¬æ¸¸æˆæ—¥å¿—åŒæ­¥äº‹ä»¶
            ioSocket.on('game_logs_sync', function(data) {
                log(`ğŸ“‹ æ”¶åˆ°æ¸¸æˆæ—¥å¿—åŒæ­¥ï¼Œå…± ${data.logs.length} æ¡è®°å½•`);
                
                // æ¸…ç©ºå½“å‰æ—¥å¿—å¹¶æ˜¾ç¤ºå®Œæ•´å†å²
                const logElement = document.getElementById('messages');
                if (logElement) {
                    logElement.innerHTML = '';
                    data.logs.forEach(logEntry => {
                        const logLine = document.createElement('div');
                        logLine.textContent = `[${new Date(logEntry.timestamp).toLocaleTimeString()}] ${logEntry.message}`;
                        logElement.appendChild(logLine);
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    logElement.scrollTop = logElement.scrollHeight;
                }
            });
        }

        function handleMessage(message) {
            log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`);
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus(false);
                log('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥');
            }
        }

        function createRoom() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            const roomName = document.getElementById('roomName').value || 'æ–°æˆ¿é—´';
            
            log(`ğŸ  åˆ›å»ºæˆ¿é—´: ${roomName}`);
            socket.emit('create_room', { name: roomName });
        }

        function joinRoom() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            const roomId = document.getElementById('joinRoomId').value;
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }

            log(`ğŸšª åŠ å…¥æˆ¿é—´: ${roomId}`);
            socket.emit('join_room', { roomId });
        }

        function getRooms() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            log('ğŸ“‹ è¯·æ±‚æˆ¿é—´åˆ—è¡¨');
            socket.emit('get_rooms');
        }

        function displayRooms(rooms) {
            const roomListDiv = document.getElementById('roomList');
            
            if (rooms.length === 0) {
                roomListDiv.innerHTML = '<p>æš‚æ— æˆ¿é—´</p>';
                return;
            }

            let html = '';
            rooms.forEach(room => {
                // è·å–æˆ¿é—´çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
                const statusText = room.status === 'playing' ? 'æ¸¸æˆä¸­' : 
                                 room.status === 'waiting' ? 'ç­‰å¾…ä¸­' : 
                                 room.status === 'finished' ? 'å·²ç»“æŸ' : room.status;
                
                // æ˜¾ç¤ºç©å®¶æ˜µç§°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                let playerNamesText = '';
                if (room.playerNames && room.playerNames.length > 0) {
                    playerNamesText = `<br><small>ç©å®¶: ${room.playerNames.join(', ')}</small>`;
                }
                
                // åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ å…¥ï¼ˆæ¸¸æˆæœªå¼€å§‹ä¸”æœªæ»¡å‘˜ï¼‰
                const canJoin = room.status === 'waiting' && room.playerCount < room.maxPlayers;
                const joinButton = canJoin ? 
                    `<button onclick="quickJoinRoom('${room.id}')">å¿«é€ŸåŠ å…¥</button>` : 
                    '<button disabled>æ— æ³•åŠ å…¥</button>';
                
                html += `
                    <div class="room-item">
                        <div>
                            <strong>${room.name}</strong> (${room.id})<br>
                            <small>æˆ¿ä¸»: ${room.host} | äººæ•°: ${room.playerCount}/${room.maxPlayers} | çŠ¶æ€: ${statusText}</small>
                            ${playerNamesText}
                        </div>
                        ${joinButton}
                    </div>
                `;
            });
            
            roomListDiv.innerHTML = html;
        }

        function quickJoinRoom(roomId) {
            document.getElementById('joinRoomId').value = roomId;
            joinRoom();
        }

        function updateCurrentRoomDisplay() {
            const currentRoomDiv = document.getElementById('currentRoom');
            
            if (!currentRoom) {
                currentRoomDiv.innerHTML = '<p>æœªåŠ å…¥ä»»ä½•æˆ¿é—´</p>';
                return;
            }

            let playersHtml = '';
            if (currentRoom.players && currentRoom.players.length > 0) {
                playersHtml = '<div class="player-list"><strong>ç©å®¶åˆ—è¡¨:</strong><br>';
                currentRoom.players.forEach(player => {
                    const hostBadge = player.isHost ? ' (æˆ¿ä¸»)' : '';
                    playersHtml += `â€¢ ${player.username}${hostBadge}<br>`;
                });
                playersHtml += '</div>';
            }

            currentRoomDiv.innerHTML = `
                <h4>å½“å‰æˆ¿é—´: ${currentRoom.name}</h4>
                <p><strong>æˆ¿é—´ID:</strong> ${currentRoom.id}</p>
                <p><strong>çŠ¶æ€:</strong> ${currentRoom.status}</p>
                <p><strong>æœ€å¤§äººæ•°:</strong> ${currentRoom.maxPlayers}</p>
                <p><strong>å½“å‰äººæ•°:</strong> ${currentRoom.players ? currentRoom.players.length : 0}</p>
                ${playersHtml}
            `;
        }

        // æ¸¸æˆç›¸å…³å˜é‡
        let gameState = null;
        let playerHand = [];
        let selectedCards = []; // å½“å‰é€‰ä¸­çš„ç‰Œ
        let currentPlayerId = null; // å½“å‰è½®åˆ°çš„ç©å®¶ID

        // è¿‡ç‰ŒåŠŸèƒ½
        function passTurn() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            if (!currentRoom) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            log('ğŸ¯ å‘é€è¿‡ç‰Œè¯·æ±‚');
            socket.emit('pass_turn', {});
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            if (!currentRoom) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            log('ğŸ® å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚');
            socket.emit('start_game', {});
        }

        // å·²ç§»é™¤æ—§çš„å‡ºç‰Œæµ‹è¯•åŠŸèƒ½ï¼Œç°åœ¨ä½¿ç”¨æ–°çš„ç‰Œé€‰æ‹©ç³»ç»Ÿ

        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameState(data) {
            if (data.gameState) {
                gameState = data.gameState;
            } else if (data) {
                // å¦‚æœç›´æ¥ä¼ å…¥gameStateå¯¹è±¡
                gameState = data;
            }
            
            if (data.currentPlayer !== undefined) {
                if (gameState) gameState.currentPlayer = data.currentPlayer;
            }
            if (data.gamePhase !== undefined) {
                if (gameState) gameState.gamePhase = data.gamePhase;
            }

            const gameStateDiv = document.getElementById('gameState');
            
            if (!gameState) {
                gameStateDiv.innerHTML = '<p>æœªå¼€å§‹æ¸¸æˆ</p>';
                return;
            }

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const currentUserInfo = getCurrentUserInfo();
            
            // æ£€æŸ¥æ˜¯å¦è½®åˆ°æˆ‘å‡ºç‰Œ
            const isMyTurn = gameState.currentPlayer && currentUserInfo && 
                            gameState.currentPlayer === currentUserInfo.id;

            // æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€
            const statusText = gameState.gamePhase === 'playing' ? 'ğŸ® æ¸¸æˆè¿›è¡Œä¸­' : gameState.gamePhase || 'ç­‰å¾…å¼€å§‹';
            
            gameStateDiv.innerHTML = `
                <div style="padding: 15px; background: #e8f5e8; border-left: 4px solid #28a745; border-radius: 4px;">
                    <p><strong>æ¸¸æˆçŠ¶æ€:</strong> ${statusText}</p>
                    <p><strong>å½“å‰å‡ºç‰Œç©å®¶ID:</strong> ${gameState.currentPlayer}</p>
                    <p><strong>è½®åˆ°æˆ‘å‡ºç‰Œ:</strong> ${isMyTurn ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p><strong>ç©å®¶æ•°é‡:</strong> ${gameState.players ? gameState.players.length : 0}/4</p>
                    <p><strong>å½“å‰çº§åˆ«:</strong> ${gameState.currentLevel || '2'}</p>
                    <p><strong>ç©å®¶é¡ºåº:</strong> [${gameState.playOrder ? gameState.playOrder.join(' â†’ ') : 'æœªçŸ¥'}]</p>
                </div>
            `;
        }

        // æ˜¾ç¤ºç©å®¶æ‰‹ç‰Œ
        function displayPlayerHand(cards) {
            playerHand = cards || [];
            const handDiv = document.getElementById('playerHand');
            
            if (playerHand.length === 0) {
                handDiv.innerHTML = '<p>æœªå‘ç‰Œ</p>';
                return;
            }

            let cardsHtml = '<p><strong>æ‰‹ç‰Œ:</strong></p>';
            cardsHtml += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            playerHand.forEach((card, index) => {
                const suitSymbol = getSuitSymbol(card.suit);
                const rankText = getRankText(card.rank);
                const isSelected = selectedCards.some(selected => 
                    selected.suit === card.suit && selected.rank === card.rank && selected.index === index
                );
                const cardStyle = isSelected 
                    ? "background: #007bff; color: white; border: 2px solid #0056b3; transform: translateY(-5px);" 
                    : "background: white; border: 1px solid #ccc;";
                
                cardsHtml += `<span onclick="toggleCardSelection(${index})" 
                    style="${cardStyle} padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.2s; user-select: none;"
                    data-card-index="${index}">
                    ${suitSymbol}${rankText}
                </span>`;
            });
            
            cardsHtml += '</div>';
            cardsHtml += `<p><strong>æ€»è®¡:</strong> ${playerHand.length}å¼ ç‰Œ</p>`;
            handDiv.innerHTML = cardsHtml;
        }

        // åˆ‡æ¢ç‰Œçš„é€‰æ‹©çŠ¶æ€
        function toggleCardSelection(index) {
            if (!gameState || gameState.gamePhase !== 'playing') {
                return; // æ¸¸æˆæœªå¼€å§‹æ—¶ä¸èƒ½é€‰ç‰Œ
            }

            const card = playerHand[index];
            if (!card) return;

            // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
            const selectedIndex = selectedCards.findIndex(selected => 
                selected.suit === card.suit && selected.rank === card.rank && selected.index === index
            );

            if (selectedIndex >= 0) {
                // å–æ¶ˆé€‰æ‹©
                selectedCards.splice(selectedIndex, 1);
            } else {
                // æ·»åŠ é€‰æ‹©
                selectedCards.push({ ...card, index: index });
            }

            // æ›´æ–°æ˜¾ç¤º
            displayPlayerHand(playerHand);
            displaySelectedCards();
            updateCardType();
            updatePlayButtons();
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„ç‰Œ
        function displaySelectedCards() {
            const selectedDiv = document.getElementById('selectedCards');
            
            if (selectedCards.length === 0) {
                selectedDiv.innerHTML = '<p style="color: #666; margin: 0;">è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œï¼ˆç‚¹å‡»æ‰‹ç‰Œé€‰æ‹©ï¼‰</p>';
                return;
            }

            let selectedHtml = '<p style="margin: 0 0 10px 0;"><strong>å·²é€‰æ‹©çš„ç‰Œ:</strong></p>';
            selectedHtml += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            selectedCards.forEach((card, index) => {
                const suitSymbol = getSuitSymbol(card.suit);
                const rankText = getRankText(card.rank);
                selectedHtml += `<span style="background: #007bff; color: white; border: 1px solid #0056b3; padding: 6px 10px; border-radius: 4px; font-size: 12px;">
                    ${suitSymbol}${rankText}
                </span>`;
            });
            
            selectedHtml += '</div>';
            selectedDiv.innerHTML = selectedHtml;
        }

        // æ›´æ–°ç‰Œå‹æ˜¾ç¤º
        function updateCardType() {
            const typeDisplay = document.getElementById('cardTypeDisplay');
            
            if (selectedCards.length === 0) {
                typeDisplay.textContent = 'ç‰Œå‹: æœªé€‰æ‹©';
                typeDisplay.style.color = '#007bff';
                return;
            }

            // è¿™é‡Œå¯ä»¥è°ƒç”¨æœåŠ¡å™¨éªŒè¯ç‰Œå‹ï¼Œæš‚æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            let cardType = 'æœªçŸ¥ç‰Œå‹';
            let isValid = false;

            if (selectedCards.length === 1) {
                cardType = 'å•ç‰Œ';
                isValid = true;
            } else if (selectedCards.length === 2) {
                if (selectedCards[0].rank === selectedCards[1].rank) {
                    cardType = 'å¯¹å­';
                    isValid = true;
                }
            } else if (selectedCards.length === 3) {
                if (selectedCards.every(card => card.rank === selectedCards[0].rank)) {
                    cardType = 'ä¸‰å¼ ';
                    isValid = true;
                }
            } else if (selectedCards.length === 4) {
                if (selectedCards.every(card => card.rank === selectedCards[0].rank)) {
                    cardType = 'å››å¼ ç‚¸å¼¹';
                    isValid = true;
                }
            }

            typeDisplay.textContent = `ç‰Œå‹: ${cardType}`;
            typeDisplay.style.color = isValid ? '#28a745' : '#dc3545';
        }

        // æ›´æ–°å‡ºç‰ŒæŒ‰é’®çŠ¶æ€
        function updatePlayButtons() {
            const confirmBtn = document.getElementById('confirmPlayBtn');
            const clearBtn = document.getElementById('clearSelectionBtn');
            
            const hasSelection = selectedCards.length > 0;
            const currentUserInfo = getCurrentUserInfo();
            const isMyTurn = gameState && gameState.gamePhase === 'playing' && 
                            currentPlayerId && currentUserInfo && 
                            currentPlayerId == currentUserInfo.id;

            confirmBtn.disabled = !hasSelection || !isMyTurn;
            clearBtn.disabled = !hasSelection;
        }

        // ç¡®è®¤å‡ºç‰Œ
        function confirmPlay() {
            if (selectedCards.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å‡ºçš„ç‰Œ');
                return;
            }

            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            if (!currentRoom || !gameState) {
                alert('æ¸¸æˆå°šæœªå¼€å§‹');
                return;
            }

            // è½¬æ¢é€‰ä¸­çš„ç‰Œä¸ºæœåŠ¡å™¨æ ¼å¼ï¼ˆç§»é™¤indexå­—æ®µï¼‰
            const cardsToPlay = selectedCards.map(card => ({
                suit: card.suit,
                rank: card.rank
            }));

            log(`ğŸ¯ å‡ºç‰Œ: ${selectedCards.length}å¼ ç‰Œ`);
            socket.emit('play_cards', { cards: cardsToPlay });
        }

        // æ¸…ç©ºé€‰æ‹©
        function clearSelection() {
            selectedCards = [];
            displayPlayerHand(playerHand);
            displaySelectedCards();
            updateCardType();
            updatePlayButtons();
        }

        // è·å–èŠ±è‰²ç¬¦å·
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'hearts': return 'â™¥';
                case 'diamonds': return 'â™¦';
                case 'clubs': return 'â™£';
                case 'spades': return 'â™ ';
                case 'joker': return 'ğŸƒ';
                default: return '?';
            }
        }

        // è·å–ç‰Œé¢æ–‡å­—
        function getRankText(rank) {
            if (rank === 1) return 'A';
            if (rank === 11) return 'J';
            if (rank === 12) return 'Q';
            if (rank === 13) return 'K';
            if (rank === 14) return 'å°ç‹';
            if (rank === 15) return 'å¤§ç‹';
            return rank.toString();
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthAndConnect();
        });
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€å¹¶è‡ªåŠ¨è¿æ¥
        function checkAuthAndConnect() {
            const token = localStorage.getItem('jwt_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (!token || !userInfo) {
                // æ²¡æœ‰ç™»å½•ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userInfo);
                document.getElementById('userInfo').innerHTML = `
                    <strong>æ¬¢è¿ï¼Œ${user.username}ï¼</strong> (ID: ${user.id})
                `;
                
                currentToken = token;
                // è‡ªåŠ¨è¿æ¥WebSocket
                connect();
            } catch (error) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_info');
                window.location.href = '/login.html';
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (socket) {
                socket.disconnect();
            }
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
        }
        
        updateStatus(false);
    </script>

    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html>