<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掼蛋游戏大厅</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .room-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
        }
        .room-item {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-list {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>🃏 掼蛋游戏大厅</h1>
    
    <div class="container">
        <div class="section">
            <h3>连接状态</h3>
            <div id="connectionStatus" class="status disconnected">正在连接...</div>
            <div id="userInfo" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px;"></div>
            <div style="margin-top: 10px;">
                <button id="disconnectBtn" onclick="logout()" disabled>退出登录</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>房间操作</h3>
            <div>
                <input type="text" id="roomName" placeholder="房间名称" value="测试房间">
                <button id="createRoomBtn" onclick="createRoom()" disabled>创建房间</button>
            </div>
            <div>
                <input type="text" id="joinRoomId" placeholder="房间ID">
                <button id="joinRoomBtn" onclick="joinRoom()" disabled>加入房间</button>
                <button id="refreshRoomsBtn" onclick="getRooms()" disabled>刷新房间列表</button>
            </div>
            <div>
                <button id="startGameBtn" onclick="startGame()" disabled>开始游戏</button>
                <button id="passTurnBtn" onclick="passTurn()" style="display: none; margin-left: 10px;" disabled>过牌</button>
                <button id="playCardsBtn" onclick="playCards()" disabled>出牌测试</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>房间列表</h3>
            <div id="roomList" class="room-list">
                <p>请先连接WebSocket...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>当前房间信息</h3>
            <div id="currentRoom">
                <p>未加入任何房间</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>游戏状态</h3>
            <div id="gameState">
                <p>未开始游戏</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>我的手牌</h3>
            <div id="playerHand">
                <p>未发牌</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>消息日志</h3>
            <div id="messageLog" class="log"></div>
            <button onclick="clearLog()">清除日志</button>
        </div>
    </div>

    <script>
        let socket = null;
        let currentToken = null;
        let currentRoom = null;

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('messageLog');
            logDiv.innerHTML += `<div>[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.textContent = '🟢 已连接到游戏服务器';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = '🔴 未连接';
                statusDiv.className = 'status disconnected';
            }
            
            // 更新按钮状态
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('createRoomBtn').disabled = !connected;
            document.getElementById('joinRoomBtn').disabled = !connected;
            document.getElementById('refreshRoomsBtn').disabled = !connected;
            
            // 根据房间状态和人数动态控制开始游戏按钮
            updateStartGameButton();
            document.getElementById('playCardsBtn').disabled = !connected || !currentRoom;
        }
        
        // 更新回合制按钮状态
        function updateTurnBasedButtons() {
            const startGameBtn = document.getElementById('startGameBtn');
            const passTurnBtn = document.getElementById('passTurnBtn');
            const currentUserInfo = getCurrentUserInfo();
            
            if (!currentUserInfo || !gameState) {
                passTurnBtn.style.display = 'none';
                return;
            }

            const isMyTurn = currentPlayerId && currentPlayerId == currentUserInfo.id;
            const isGamePlaying = gameState && gameState.gamePhase === 'playing';

            if (isGamePlaying) {
                // 游戏进行中，显示过牌按钮
                passTurnBtn.style.display = 'inline-block';
                passTurnBtn.disabled = !isMyTurn;
                passTurnBtn.textContent = isMyTurn ? '过牌' : '等待中...';
                
                // 隐藏开始游戏按钮
                startGameBtn.style.display = 'none';
            } else {
                // 游戏未开始，隐藏过牌按钮
                passTurnBtn.style.display = 'none';
                startGameBtn.style.display = 'inline-block';
            }
        }

        // 获取当前用户信息
        function getCurrentUserInfo() {
            const userInfoStr = localStorage.getItem('user_info');
            return userInfoStr ? JSON.parse(userInfoStr) : null;
        }

        // 动态更新开始游戏按钮状态
        function updateStartGameButton() {
            const startGameBtn = document.getElementById('startGameBtn');
            const connected = socket && socket.connected;
            
            if (!connected || !currentRoom) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = '开始游戏';
                return;
            }
            
            const playerCount = currentRoom.players ? currentRoom.players.length : 0;
            const isPlaying = currentRoom.status === 'playing';
            
            if (isPlaying) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = '游戏进行中...';
                startGameBtn.style.display = 'none'; // 隐藏按钮
            } else if (playerCount >= 4) {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `满员自动开始 (${playerCount}/4人)`;
                startGameBtn.style.backgroundColor = '#28a745'; // 绿色表示满员
            } else {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `等待玩家 (${playerCount}/4人)`;
                startGameBtn.style.backgroundColor = '#ccc'; // 灰色表示等待
                startGameBtn.style.display = 'block'; // 显示按钮
            }
        }


        function connect() {
            if (!currentToken) {
                log('❌ 没有找到登录Token，正在重定向到登录页...');
                window.location.href = '/login.html';
                return;
            }

            log(`🔗 尝试连接Socket.IO WebSocket服务器...`);
            log(`🔑 使用Token: ${currentToken.substring(0, 20)}...`);
            
            // Socket.IO 连接 - 正确配置路径
            const ioSocket = io({
                path: '/ws/socket.io/',  // 正确的Socket.IO路径
                auth: {
                    token: currentToken
                },
                transports: ['websocket', 'polling'], // 允许降级到polling
                timeout: 10000, // 10秒连接超时
                forceNew: true  // 强制创建新连接
            });

            socket = ioSocket;

            ioSocket.on('connect', function() {
                log('✅ Socket.IO连接成功');
                updateStatus(true);
            });

            ioSocket.on('disconnect', function() {
                log('❌ Socket.IO连接断开');
                updateStatus(false);
            });

            ioSocket.on('rooms_list', function(data) {
                log(`📋 收到房间列表: ${JSON.stringify(data)}`);
                displayRooms(data.rooms || []);
            });

            ioSocket.on('room_created', function(data) {
                log(`🏠 房间创建响应: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_joined', function(data) {
                log(`🚪 加入房间响应: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_update', function(data) {
                log(`🔄 房间更新: ${JSON.stringify(data)}`);
                if (data.room) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                    // 动态更新开始游戏按钮状态
                    updateStartGameButton();
                    // 更新回合制按钮状态
                    updateTurnBasedButtons();
                    // 刷新房间列表
                    getRooms();
                }
                
                // 处理自动开始游戏的特殊消息
                if (data.type === 'auto_game_started') {
                    log(`🎮 ${data.message}`);
                    // 显示自动开始的通知
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed; top: 20px; right: 20px;
                        background: #28a745; color: white;
                        padding: 15px 20px; border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000; font-weight: bold;
                    `;
                    notification.textContent = '🎮 ' + data.message;
                    document.body.appendChild(notification);
                    
                    // 3秒后自动移除通知
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 3000);
                }
            });

            ioSocket.on('connect_error', function(error) {
                log(`❌ Socket.IO连接错误: ${error.message}`);
                log(`❌ 错误详情: ${JSON.stringify(error)}`);
                updateStatus(false);
            });

            ioSocket.on('disconnect', function(reason) {
                log(`🔌 Socket.IO断开连接，原因: ${reason}`);
                updateStatus(false);
            });

            // 添加更多调试事件
            ioSocket.on('connecting', function() {
                log(`🔄 Socket.IO正在连接...`);
            });

            ioSocket.on('reconnect', function() {
                log(`🔄 Socket.IO已重连`);
                updateStatus(true);
            });

            ioSocket.on('reconnect_error', function(error) {
                log(`❌ Socket.IO重连失败: ${error.message}`);
            });

            // 游戏相关事件
            ioSocket.on('game_started', function(data) {
                log(`🎮 游戏开始: ${JSON.stringify(data)}`);
                
                if (data.gameState) {
                    gameState = data.gameState;
                    currentPlayerId = data.gameState.currentPlayerId || data.gameState.playOrder[0];
                    updateGameState(data);
                    updateTurnBasedButtons(); // 更新回合制按钮状态
                    
                    log(`🎯 游戏玩家顺序: [${data.gameState.playOrder.join(', ')}]`);
                    log(`🎯 当前轮到玩家: ${currentPlayerId}`);
                }
            });

            // 监听回合更新事件
            ioSocket.on('turn_update', function(data) {
                log(`🔄 回合更新: ${JSON.stringify(data)}`);
                currentPlayerId = data.currentPlayerId;
                updateTurnBasedButtons(); // 更新回合制按钮状态
                
                if (data.message) {
                    log(`📢 ${data.message}`);
                }
            });

            // 监听过牌结果
            ioSocket.on('pass_turn_result', function(data) {
                if (data.success) {
                    log(`✅ ${data.message}`);
                } else {
                    log(`❌ 过牌失败: ${data.message}`);
                    alert(data.message);
                }
            });

            // 监听出牌事件
            ioSocket.on('cards_played', function(data) {
                log(`🃏 ${data.playerName} 出牌: ${data.cards.length}张，剩余${data.remainingCards}张`);
            });

            // 监听出牌结果
            ioSocket.on('play_cards_result', function(data) {
                if (data.success) {
                    log(`✅ ${data.message}`);
                } else {
                    log(`❌ 出牌失败: ${data.message}`);
                    alert(data.message);
                }
            });

            ioSocket.on('your_hand', function(data) {
                log(`🃏 收到手牌: ${data.playerCount}张牌`);
                displayPlayerHand(data.cards);
            });

            ioSocket.on('card_played', function(data) {
                log(`🎯 玩家出牌: ${data.username} 出了 ${data.cards.length}张${data.playType}，剩余${data.remainingCards}张`);
                updateGameState({ currentPlayer: data.nextPlayer });
            });

            ioSocket.on('game_finished', function(data) {
                log(`🏆 游戏结束: ${data.message}`);
                updateGameState({ gamePhase: 'finished', winner: data.winner });
            });

            // 监听断线重连成功事件
            ioSocket.on('reconnect_success', function(data) {
                log(`🔄 重连成功: ${data.message}`);
                
                // 恢复房间状态
                if (data.room) {
                    currentRoom = data.room;
                    log(`🏠 已恢复房间状态: ${data.room.id}`);
                    updateStartGameButton();
                }
                
                // 恢复游戏状态
                if (data.gameState) {
                    log(`🎮 已恢复游戏状态，当前轮到: 玩家${data.gameState.currentPlayerId}`);
                    currentPlayerId = data.gameState.currentPlayerId;
                    updateTurnBasedButtons();
                    updateGameState(data.gameState);
                }
                
                // 恢复手牌
                if (data.yourCards && data.yourCards.length > 0) {
                    log(`🃏 已恢复手牌: ${data.yourCards.length}张`);
                    displayPlayerHand(data.yourCards);
                }
                
                // 请求完整的游戏日志
                if (data.room) {
                    socket.emit('request_game_logs', { roomId: data.room.id });
                }
                
                alert('重连成功！已恢复到断线前的游戏状态。');
            });

            // 监听玩家断线事件
            ioSocket.on('player_disconnected', function(data) {
                log(`🔌 ${data.playerName} 断线了，等待重连...`);
            });

            // 监听玩家重连事件
            ioSocket.on('player_reconnected', function(data) {
                log(`🔗 ${data.playerName} 重新连接了`);
            });

            // 监听游戏日志同步事件
            ioSocket.on('game_logs_sync', function(data) {
                log(`📋 收到游戏日志同步，共 ${data.logs.length} 条记录`);
                
                // 清空当前日志并显示完整历史
                const logElement = document.getElementById('messages');
                if (logElement) {
                    logElement.innerHTML = '';
                    data.logs.forEach(logEntry => {
                        const logLine = document.createElement('div');
                        logLine.textContent = `[${new Date(logEntry.timestamp).toLocaleTimeString()}] ${logEntry.message}`;
                        logElement.appendChild(logLine);
                    });
                    
                    // 滚动到底部
                    logElement.scrollTop = logElement.scrollHeight;
                }
            });
        }

        function handleMessage(message) {
            log(`📨 收到消息: ${JSON.stringify(message)}`);
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus(false);
                log('🔌 主动断开连接');
            }
        }

        function createRoom() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            const roomName = document.getElementById('roomName').value || '新房间';
            
            log(`🏠 创建房间: ${roomName}`);
            socket.emit('create_room', { name: roomName });
        }

        function joinRoom() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            const roomId = document.getElementById('joinRoomId').value;
            if (!roomId) {
                alert('请输入房间ID');
                return;
            }

            log(`🚪 加入房间: ${roomId}`);
            socket.emit('join_room', { roomId });
        }

        function getRooms() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            log('📋 请求房间列表');
            socket.emit('get_rooms');
        }

        function displayRooms(rooms) {
            const roomListDiv = document.getElementById('roomList');
            
            if (rooms.length === 0) {
                roomListDiv.innerHTML = '<p>暂无房间</p>';
                return;
            }

            let html = '';
            rooms.forEach(room => {
                html += `
                    <div class="room-item">
                        <div>
                            <strong>${room.name}</strong> (${room.id})<br>
                            <small>房主: ${room.host} | 人数: ${room.playerCount}/${room.maxPlayers} | 状态: ${room.status}</small>
                        </div>
                        <button onclick="quickJoinRoom('${room.id}')">快速加入</button>
                    </div>
                `;
            });
            
            roomListDiv.innerHTML = html;
        }

        function quickJoinRoom(roomId) {
            document.getElementById('joinRoomId').value = roomId;
            joinRoom();
        }

        function updateCurrentRoomDisplay() {
            const currentRoomDiv = document.getElementById('currentRoom');
            
            if (!currentRoom) {
                currentRoomDiv.innerHTML = '<p>未加入任何房间</p>';
                return;
            }

            let playersHtml = '';
            if (currentRoom.players && currentRoom.players.length > 0) {
                playersHtml = '<div class="player-list"><strong>玩家列表:</strong><br>';
                currentRoom.players.forEach(player => {
                    const hostBadge = player.isHost ? ' (房主)' : '';
                    playersHtml += `• ${player.username}${hostBadge}<br>`;
                });
                playersHtml += '</div>';
            }

            currentRoomDiv.innerHTML = `
                <h4>当前房间: ${currentRoom.name}</h4>
                <p><strong>房间ID:</strong> ${currentRoom.id}</p>
                <p><strong>状态:</strong> ${currentRoom.status}</p>
                <p><strong>最大人数:</strong> ${currentRoom.maxPlayers}</p>
                <p><strong>当前人数:</strong> ${currentRoom.players ? currentRoom.players.length : 0}</p>
                ${playersHtml}
            `;
        }

        // 游戏相关变量
        let gameState = null;
        let playerHand = [];
        let currentPlayerId = null; // 当前轮到的玩家ID

        // 过牌功能
        function passTurn() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            if (!currentRoom) {
                alert('请先加入房间');
                return;
            }

            log('🎯 发送过牌请求');
            socket.emit('pass_turn', {});
        }

        // 开始游戏
        function startGame() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            if (!currentRoom) {
                alert('请先加入房间');
                return;
            }

            log('🎮 发送开始游戏请求');
            socket.emit('start_game', {});
        }

        // 出牌测试 (出第一张牌)
        function playCards() {
            if (!socket || !socket.connected) {
                alert('请先连接WebSocket');
                return;
            }

            if (!currentRoom || !gameState) {
                alert('游戏尚未开始');
                return;
            }

            if (playerHand.length === 0) {
                alert('没有手牌');
                return;
            }

            // 简单测试：出第一张牌
            const cardsToPlay = [playerHand[0]];
            log(`🎯 出牌: ${cardsToPlay.length}张牌`);
            socket.emit('play_cards', { cards: cardsToPlay });
        }

        // 更新游戏状态显示
        function updateGameState(data) {
            if (data.gameState) {
                gameState = data.gameState;
            }
            if (data.currentPlayer !== undefined) {
                if (gameState) gameState.currentPlayer = data.currentPlayer;
            }
            if (data.gamePhase !== undefined) {
                if (gameState) gameState.gamePhase = data.gamePhase;
            }

            const gameStateDiv = document.getElementById('gameState');
            
            if (!gameState) {
                gameStateDiv.innerHTML = '<p>未开始游戏</p>';
                return;
            }

            const isMyTurn = gameState.currentPlayer && currentToken && 
                            gameState.players && gameState.players.includes(gameState.currentPlayer);

            gameStateDiv.innerHTML = `
                <p><strong>游戏阶段:</strong> ${gameState.gamePhase}</p>
                <p><strong>当前玩家:</strong> ${gameState.currentPlayer}</p>
                <p><strong>轮到我出牌:</strong> ${isMyTurn ? '是' : '否'}</p>
                <p><strong>玩家数量:</strong> ${gameState.players ? gameState.players.length : 0}</p>
            `;
        }

        // 显示玩家手牌
        function displayPlayerHand(cards) {
            playerHand = cards || [];
            const handDiv = document.getElementById('playerHand');
            
            if (playerHand.length === 0) {
                handDiv.innerHTML = '<p>未发牌</p>';
                return;
            }

            let cardsHtml = '<p><strong>手牌:</strong></p>';
            cardsHtml += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            playerHand.forEach((card, index) => {
                const suitSymbol = getSuitSymbol(card.suit);
                const rankText = getRankText(card.rank);
                cardsHtml += `<span style="background: white; border: 1px solid #ccc; padding: 3px 6px; border-radius: 3px; font-size: 12px;">
                    ${suitSymbol}${rankText}
                </span>`;
            });
            
            cardsHtml += '</div>';
            cardsHtml += `<p><strong>总计:</strong> ${playerHand.length}张牌</p>`;
            handDiv.innerHTML = cardsHtml;
        }

        // 获取花色符号
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'hearts': return '♥';
                case 'diamonds': return '♦';
                case 'clubs': return '♣';
                case 'spades': return '♠';
                case 'joker': return '🃏';
                default: return '?';
            }
        }

        // 获取牌面文字
        function getRankText(rank) {
            if (rank === 1) return 'A';
            if (rank === 11) return 'J';
            if (rank === 12) return 'Q';
            if (rank === 13) return 'K';
            if (rank === 14) return '小王';
            if (rank === 15) return '大王';
            return rank.toString();
        }

        // 页面加载时的初始化
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthAndConnect();
        });
        
        // 检查认证状态并自动连接
        function checkAuthAndConnect() {
            const token = localStorage.getItem('jwt_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (!token || !userInfo) {
                // 没有登录信息，重定向到登录页
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userInfo);
                document.getElementById('userInfo').innerHTML = `
                    <strong>欢迎，${user.username}！</strong> (ID: ${user.id})
                `;
                
                currentToken = token;
                // 自动连接WebSocket
                connect();
            } catch (error) {
                console.error('解析用户信息失败:', error);
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_info');
                window.location.href = '/login.html';
            }
        }
        
        // 退出登录
        function logout() {
            if (socket) {
                socket.disconnect();
            }
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
        }
        
        updateStatus(false);
    </script>

    <!-- Socket.IO 客户端库 -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html>