<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæ¸¸æˆæˆ¿é—´æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .room-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
        }
        .room-item {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-list {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>WebSocket æ¸¸æˆæˆ¿é—´æµ‹è¯•å®¢æˆ·ç«¯</h1>
    
    <div class="container">
        <div class="section">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus" class="status disconnected">æœªè¿æ¥</div>
            
            <h3>ç”¨æˆ·è®¤è¯</h3>
            <div>
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="testuser">
                <input type="password" id="password" placeholder="å¯†ç " value="testpass">
                <button id="loginBtn" onclick="login()">ç™»å½•</button>
            </div>
            <div>
                <input type="text" id="token" placeholder="JWT Token (è‡ªåŠ¨å¡«å…¥)" readonly>
                <button id="connectBtn" onclick="connect()" disabled>è¿æ¥ WebSocket</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ¿é—´æ“ä½œ</h3>
            <div>
                <input type="text" id="roomName" placeholder="æˆ¿é—´åç§°" value="æµ‹è¯•æˆ¿é—´">
                <button id="createRoomBtn" onclick="createRoom()" disabled>åˆ›å»ºæˆ¿é—´</button>
            </div>
            <div>
                <input type="text" id="joinRoomId" placeholder="æˆ¿é—´ID">
                <button id="joinRoomBtn" onclick="joinRoom()" disabled>åŠ å…¥æˆ¿é—´</button>
                <button id="refreshRoomsBtn" onclick="getRooms()" disabled>åˆ·æ–°æˆ¿é—´åˆ—è¡¨</button>
            </div>
            <div>
                <button id="startGameBtn" onclick="startGame()" disabled>å¼€å§‹æ¸¸æˆ</button>
                <button id="playCardsBtn" onclick="playCards()" disabled>å‡ºç‰Œæµ‹è¯•</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ¿é—´åˆ—è¡¨</h3>
            <div id="roomList" class="room-list">
                <p>è¯·å…ˆè¿æ¥WebSocket...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>å½“å‰æˆ¿é—´ä¿¡æ¯</h3>
            <div id="currentRoom">
                <p>æœªåŠ å…¥ä»»ä½•æˆ¿é—´</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æ¸¸æˆçŠ¶æ€</h3>
            <div id="gameState">
                <p>æœªå¼€å§‹æ¸¸æˆ</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æˆ‘çš„æ‰‹ç‰Œ</h3>
            <div id="playerHand">
                <p>æœªå‘ç‰Œ</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æ¶ˆæ¯æ—¥å¿—</h3>
            <div id="messageLog" class="log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        let socket = null;
        let currentToken = null;
        let currentRoom = null;

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('messageLog');
            logDiv.innerHTML += `<div>[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.textContent = 'å·²è¿æ¥';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'æœªè¿æ¥';
                statusDiv.className = 'status disconnected';
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('connectBtn').disabled = connected || !currentToken;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('createRoomBtn').disabled = !connected;
            document.getElementById('joinRoomBtn').disabled = !connected;
            document.getElementById('refreshRoomsBtn').disabled = !connected;
            document.getElementById('startGameBtn').disabled = !connected || !currentRoom;
            document.getElementById('playCardsBtn').disabled = !connected || !currentRoom;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.data.token;
                    document.getElementById('token').value = currentToken;
                    document.getElementById('connectBtn').disabled = false;
                    log(`âœ… ç™»å½•æˆåŠŸ: ${result.data.user.username}`);
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${result.message}`);
                    alert(`ç™»å½•å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                log(`âŒ ç™»å½•è¯·æ±‚é”™è¯¯: ${error.message}`);
                alert(`ç™»å½•è¯·æ±‚é”™è¯¯: ${error.message}`);
            }
        }

        function connect() {
            if (!currentToken) {
                alert('è¯·å…ˆç™»å½•è·å–Token');
                return;
            }

            log(`ğŸ”— å°è¯•è¿æ¥Socket.IO WebSocketæœåŠ¡å™¨...`);
            log(`ğŸ”‘ ä½¿ç”¨Token: ${currentToken.substring(0, 20)}...`);
            
            // Socket.IO è¿æ¥ - æ­£ç¡®é…ç½®è·¯å¾„
            const ioSocket = io({
                path: '/ws/socket.io/',  // æ­£ç¡®çš„Socket.IOè·¯å¾„
                auth: {
                    token: currentToken
                },
                transports: ['websocket', 'polling'], // å…è®¸é™çº§åˆ°polling
                timeout: 10000, // 10ç§’è¿æ¥è¶…æ—¶
                forceNew: true  // å¼ºåˆ¶åˆ›å»ºæ–°è¿æ¥
            });

            socket = ioSocket;

            ioSocket.on('connect', function() {
                log('âœ… Socket.IOè¿æ¥æˆåŠŸ');
                updateStatus(true);
            });

            ioSocket.on('disconnect', function() {
                log('âŒ Socket.IOè¿æ¥æ–­å¼€');
                updateStatus(false);
            });

            ioSocket.on('rooms_list', function(data) {
                log(`ğŸ“‹ æ”¶åˆ°æˆ¿é—´åˆ—è¡¨: ${JSON.stringify(data)}`);
                displayRooms(data.rooms || []);
            });

            ioSocket.on('room_created', function(data) {
                log(`ğŸ  æˆ¿é—´åˆ›å»ºå“åº”: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_joined', function(data) {
                log(`ğŸšª åŠ å…¥æˆ¿é—´å“åº”: ${JSON.stringify(data)}`);
                if (data.success) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('room_update', function(data) {
                log(`ğŸ”„ æˆ¿é—´æ›´æ–°: ${JSON.stringify(data)}`);
                if (data.room) {
                    currentRoom = data.room;
                    updateCurrentRoomDisplay();
                }
            });

            ioSocket.on('connect_error', function(error) {
                log(`âŒ Socket.IOè¿æ¥é”™è¯¯: ${error.message}`);
                log(`âŒ é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`);
                updateStatus(false);
            });

            ioSocket.on('disconnect', function(reason) {
                log(`ğŸ”Œ Socket.IOæ–­å¼€è¿æ¥ï¼ŒåŸå› : ${reason}`);
                updateStatus(false);
            });

            // æ·»åŠ æ›´å¤šè°ƒè¯•äº‹ä»¶
            ioSocket.on('connecting', function() {
                log(`ğŸ”„ Socket.IOæ­£åœ¨è¿æ¥...`);
            });

            ioSocket.on('reconnect', function() {
                log(`ğŸ”„ Socket.IOå·²é‡è¿`);
                updateStatus(true);
            });

            ioSocket.on('reconnect_error', function(error) {
                log(`âŒ Socket.IOé‡è¿å¤±è´¥: ${error.message}`);
            });

            // æ¸¸æˆç›¸å…³äº‹ä»¶
            ioSocket.on('game_started', function(data) {
                log(`ğŸ® æ¸¸æˆå¼€å§‹: ${JSON.stringify(data)}`);
                updateGameState(data);
            });

            ioSocket.on('your_hand', function(data) {
                log(`ğŸƒ æ”¶åˆ°æ‰‹ç‰Œ: ${data.playerCount}å¼ ç‰Œ`);
                displayPlayerHand(data.cards);
            });

            ioSocket.on('card_played', function(data) {
                log(`ğŸ¯ ç©å®¶å‡ºç‰Œ: ${data.username} å‡ºäº† ${data.cards.length}å¼ ${data.playType}ï¼Œå‰©ä½™${data.remainingCards}å¼ `);
                updateGameState({ currentPlayer: data.nextPlayer });
            });

            ioSocket.on('game_finished', function(data) {
                log(`ğŸ† æ¸¸æˆç»“æŸ: ${data.message}`);
                updateGameState({ gamePhase: 'finished', winner: data.winner });
            });
        }

        function handleMessage(message) {
            log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`);
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus(false);
                log('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥');
            }
        }

        function createRoom() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            const roomName = document.getElementById('roomName').value || 'æ–°æˆ¿é—´';
            
            log(`ğŸ  åˆ›å»ºæˆ¿é—´: ${roomName}`);
            socket.emit('create_room', { name: roomName });
        }

        function joinRoom() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            const roomId = document.getElementById('joinRoomId').value;
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }

            log(`ğŸšª åŠ å…¥æˆ¿é—´: ${roomId}`);
            socket.emit('join_room', { roomId });
        }

        function getRooms() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            log('ğŸ“‹ è¯·æ±‚æˆ¿é—´åˆ—è¡¨');
            socket.emit('get_rooms');
        }

        function displayRooms(rooms) {
            const roomListDiv = document.getElementById('roomList');
            
            if (rooms.length === 0) {
                roomListDiv.innerHTML = '<p>æš‚æ— æˆ¿é—´</p>';
                return;
            }

            let html = '';
            rooms.forEach(room => {
                html += `
                    <div class="room-item">
                        <div>
                            <strong>${room.name}</strong> (${room.id})<br>
                            <small>æˆ¿ä¸»: ${room.host} | äººæ•°: ${room.playerCount}/${room.maxPlayers} | çŠ¶æ€: ${room.status}</small>
                        </div>
                        <button onclick="quickJoinRoom('${room.id}')">å¿«é€ŸåŠ å…¥</button>
                    </div>
                `;
            });
            
            roomListDiv.innerHTML = html;
        }

        function quickJoinRoom(roomId) {
            document.getElementById('joinRoomId').value = roomId;
            joinRoom();
        }

        function updateCurrentRoomDisplay() {
            const currentRoomDiv = document.getElementById('currentRoom');
            
            if (!currentRoom) {
                currentRoomDiv.innerHTML = '<p>æœªåŠ å…¥ä»»ä½•æˆ¿é—´</p>';
                return;
            }

            let playersHtml = '';
            if (currentRoom.players && currentRoom.players.length > 0) {
                playersHtml = '<div class="player-list"><strong>ç©å®¶åˆ—è¡¨:</strong><br>';
                currentRoom.players.forEach(player => {
                    const hostBadge = player.isHost ? ' (æˆ¿ä¸»)' : '';
                    playersHtml += `â€¢ ${player.username}${hostBadge}<br>`;
                });
                playersHtml += '</div>';
            }

            currentRoomDiv.innerHTML = `
                <h4>å½“å‰æˆ¿é—´: ${currentRoom.name}</h4>
                <p><strong>æˆ¿é—´ID:</strong> ${currentRoom.id}</p>
                <p><strong>çŠ¶æ€:</strong> ${currentRoom.status}</p>
                <p><strong>æœ€å¤§äººæ•°:</strong> ${currentRoom.maxPlayers}</p>
                <p><strong>å½“å‰äººæ•°:</strong> ${currentRoom.players ? currentRoom.players.length : 0}</p>
                ${playersHtml}
            `;
        }

        // æ¸¸æˆç›¸å…³å˜é‡
        let gameState = null;
        let playerHand = [];

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            if (!currentRoom) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            log('ğŸ® å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚');
            socket.emit('start_game', {});
        }

        // å‡ºç‰Œæµ‹è¯• (å‡ºç¬¬ä¸€å¼ ç‰Œ)
        function playCards() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆè¿æ¥WebSocket');
                return;
            }

            if (!currentRoom || !gameState) {
                alert('æ¸¸æˆå°šæœªå¼€å§‹');
                return;
            }

            if (playerHand.length === 0) {
                alert('æ²¡æœ‰æ‰‹ç‰Œ');
                return;
            }

            // ç®€å•æµ‹è¯•ï¼šå‡ºç¬¬ä¸€å¼ ç‰Œ
            const cardsToPlay = [playerHand[0]];
            log(`ğŸ¯ å‡ºç‰Œ: ${cardsToPlay.length}å¼ ç‰Œ`);
            socket.emit('play_cards', { cards: cardsToPlay });
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameState(data) {
            if (data.gameState) {
                gameState = data.gameState;
            }
            if (data.currentPlayer !== undefined) {
                if (gameState) gameState.currentPlayer = data.currentPlayer;
            }
            if (data.gamePhase !== undefined) {
                if (gameState) gameState.gamePhase = data.gamePhase;
            }

            const gameStateDiv = document.getElementById('gameState');
            
            if (!gameState) {
                gameStateDiv.innerHTML = '<p>æœªå¼€å§‹æ¸¸æˆ</p>';
                return;
            }

            const isMyTurn = gameState.currentPlayer && currentToken && 
                            gameState.players && gameState.players.includes(gameState.currentPlayer);

            gameStateDiv.innerHTML = `
                <p><strong>æ¸¸æˆé˜¶æ®µ:</strong> ${gameState.gamePhase}</p>
                <p><strong>å½“å‰ç©å®¶:</strong> ${gameState.currentPlayer}</p>
                <p><strong>è½®åˆ°æˆ‘å‡ºç‰Œ:</strong> ${isMyTurn ? 'æ˜¯' : 'å¦'}</p>
                <p><strong>ç©å®¶æ•°é‡:</strong> ${gameState.players ? gameState.players.length : 0}</p>
            `;
        }

        // æ˜¾ç¤ºç©å®¶æ‰‹ç‰Œ
        function displayPlayerHand(cards) {
            playerHand = cards || [];
            const handDiv = document.getElementById('playerHand');
            
            if (playerHand.length === 0) {
                handDiv.innerHTML = '<p>æœªå‘ç‰Œ</p>';
                return;
            }

            let cardsHtml = '<p><strong>æ‰‹ç‰Œ:</strong></p>';
            cardsHtml += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            playerHand.forEach((card, index) => {
                const suitSymbol = getSuitSymbol(card.suit);
                const rankText = getRankText(card.rank);
                cardsHtml += `<span style="background: white; border: 1px solid #ccc; padding: 3px 6px; border-radius: 3px; font-size: 12px;">
                    ${suitSymbol}${rankText}
                </span>`;
            });
            
            cardsHtml += '</div>';
            cardsHtml += `<p><strong>æ€»è®¡:</strong> ${playerHand.length}å¼ ç‰Œ</p>`;
            handDiv.innerHTML = cardsHtml;
        }

        // è·å–èŠ±è‰²ç¬¦å·
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'hearts': return 'â™¥';
                case 'diamonds': return 'â™¦';
                case 'clubs': return 'â™£';
                case 'spades': return 'â™ ';
                case 'joker': return 'ğŸƒ';
                default: return '?';
            }
        }

        // è·å–ç‰Œé¢æ–‡å­—
        function getRankText(rank) {
            if (rank === 1) return 'A';
            if (rank === 11) return 'J';
            if (rank === 12) return 'Q';
            if (rank === 13) return 'K';
            if (rank === 14) return 'å°ç‹';
            if (rank === 15) return 'å¤§ç‹';
            return rank.toString();
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        updateStatus(false);
    </script>

    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html>